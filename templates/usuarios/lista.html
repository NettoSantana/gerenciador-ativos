{% extends "base.html" %}
{% block title %}Usuários{% endblock %}

{% block content %}
<div class="page">

  <style>
    /* Responsividade apenas para telas pequenas */
    @media (max-width: 640px) {
      .wrapper-table-mobile {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .wrapper-table-mobile table {
        min-width: 650px; /* garante que a tabela não quebre */
      }
    }
  </style>

  <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
    <h1>Usuários</h1>
    <a href="{{ url_for('usuarios.novo') }}" class="btn-primary">Novo Usuário</a>
  </div>

  <div class="card" style="width:100%; max-width:100%; padding:0;">

    <!-- WRAPPER MOBILE -->
    <div class="wrapper-table-mobile">

      <table class="table" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="padding:14px 20px;">Nome</th>
            <th style="padding:14px 20px;">Email</th>
            <th style="padding:14px 20px;">Tipo</th>
            <th style="padding:14px 20px;">Status</th>
            <th style="padding:14px 20px;">Ações</th>
          </tr>
        </thead>

        <tbody>
          {% for u in usuarios %}
          <tr style="border-top:1px solid rgba(148,163,184,0.18);">

            <td style="padding:14px 20px;">{{ u.nome }}</td>
            <td style="padding:14px 20px;">{{ u.email }}</td>
            <td style="padding:14px 20px; text-transform:capitalize;">{{ u.tipo }}</td>

            <td style="padding:14px 20px;">
              {% if u.ativo %}
                <span class="chip" style="background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.4); color:#22c55e;">
                  Ativo
                </span>
              {% else %}
                <span class="chip" style="background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4); color:#ef4444;">
                  Inativo
                </span>
              {% endif %}
            </td>

            <td style="padding:14px 20px; display:flex; gap:10px;">

              <!-- EDITAR -->
              <a href="{{ url_for('usuarios.editar', id=u.id) }}" class="btn-ghost">Editar</a>

              <!-- ATIVAR / DESATIVAR -->
              {% if u.ativo %}
                <a href="{{ url_for('usuarios.toggle', id=u.id) }}" class="btn-ghost">Desativar</a>
              {% else %}
                <a href="{{ url_for('usuarios.toggle', id=u.id) }}" class="btn-ghost">Ativar</a>
              {% endif %}

              {% set logado = session.get('user_tipo') %}

              {% if u.email != 'admin@admin.com' %}
                {% if u.id != session.get('user_id') %}

                  {% if logado == 'admin' %}
                    <form action="{{ url_for('usuarios.excluir', id=u.id) }}" method="POST"
                          onsubmit="return confirm('Tem certeza que deseja excluir este usuário?');">
                      <button type="submit" class="btn-ghost" style="color:#ef4444;">Excluir</button>
                    </form>

                  {% elif logado == 'gerente' %}
                    {% if u.tipo != 'gerente' %}
                      <form action="{{ url_for('usuarios.excluir', id=u.id) }}" method="POST"
                            onsubmit="return confirm('Tem certeza que deseja excluir este usuário?');">
                        <button type="submit" class="btn-ghost" style="color:#ef4444;">Excluir</button>
                      </form>
                    {% endif %}
                  {% endif %}

                {% endif %}
              {% endif %}

            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div> <!-- fim wrapper -->

  </div>

</div>
{% endblock %}
