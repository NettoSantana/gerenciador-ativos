{% extends "base.html" %}
{% block title %}Painel do Ativo{% endblock %}

{% block content %}
<div class="page">

<!-- ===================== STYLE ===================== -->
<style>
  .painel-header-top{
    display:flex;justify-content:space-between;align-items:flex-start;
    gap:16px;flex-wrap:wrap;margin-bottom:12px;
  }
  .painel-titulo h1{
    margin:0;font-size:24px;font-weight:700;
  }
  .painel-titulo .sub{
    margin-top:4px;font-size:13px;color:#94a3b8;
  }
  .pill-strip{
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
  }
  .pill-badge{
    padding:6px 10px;border-radius:999px;font-size:12px;
    background:#020617;border:1px solid #1f2937;color:#e5e7eb;
  }

  .tab-row{
    display:flex;gap:10px;margin:20px 0;
  }
  .tab-btn{
    padding:10px 18px;border-radius:999px;font-size:14px;
    border:1px solid #1f2937;background:#0f172a;color:#e5e7eb;
    cursor:pointer;transition:.2s;
  }
  .tab-btn.active{
    color:#38bdf8;border-color:#38bdf8;
    box-shadow:0 0 0 1px rgba(56,189,248,.3);
  }

  .grid-painel{
    display:grid;grid-template-columns:repeat(12,1fr);gap:16px;
  }
  @media (max-width:900px){
    .col-4,.col-6,.col-12{grid-column:span 12;}
  }
  @media (min-width:901px){
    .col-4{grid-column:span 4;}
    .col-6{grid-column:span 6;}
    .col-12{grid-column:span 12;}
  }

  .card-kpi,.card-form{
    background:#0b1220;border-radius:16px;
    border:1px solid #1f2937;padding:20px;
    box-shadow:0 10px 25px rgba(0,0,0,.3);
  }
  .card-kpi h2,.card-form h3{
    margin:0 0 10px;color:#38bdf8;font-size:15px;
    text-transform:uppercase;
  }
  .kpi-value{
    font-size:30px;font-weight:800;margin-bottom:6px;color:#e2e8f0;
  }
  .kpi-helper{
    font-size:13px;color:#9ca3af;
  }

  .status-row{
    display:flex;align-items:center;gap:8px;
    margin-top:6px;font-size:13px;
  }
  .status-dot{
    width:10px;height:10px;border-radius:999px;background:#4b5563;
  }
  .status-dot.ok{background:#22c55e;}
  .status-dot.bad{background:#ef4444;}

  .hidden{display:none;}
</style>

<!-- ===================== HEADER ===================== -->
<div class="painel-header-top">
  <div class="painel-titulo">
    <h1>Painel — {{ ativo.nome }}</h1>
    <div class="sub">
      Ativo #{{ ativo.id }} — Cliente: {{ ativo.cliente.nome if ativo.cliente else '—' }}
    </div>
  </div>

  <div class="pill-strip">
    <div class="pill-badge" id="badgeUltima">Última: --</div>
    <div class="pill-badge">IMEI: <span id="badgeImei">--</span></div>
  </div>
</div>

<!-- ===================== TABS ===================== -->
<div class="tab-row">
  <button id="btnTabPainel" class="tab-btn active">Painel</button>
  <button id="btnTabPreventiva" class="tab-btn">Preventiva</button>
</div>

<!-- ===================== VIEW PAINEL ===================== -->
<section id="viewPainel" class="grid-painel">

  <div class="card-kpi col-4">
    <h2>Status monitoramento</h2>
    <div class="kpi-value" id="kpiMonitor">--</div>
    <div class="kpi-helper">Situação geral</div>
  </div>

  <div class="card-kpi col-4">
    <h2>Horas motor</h2>
    <div class="kpi-value" id="kpiHorasMotor">0.00 h</div>
    <div class="kpi-helper">Total consolidado</div>
  </div>

  <a href="/ativos/{{ ativo.id }}/consumo"
     class="card-kpi col-4"
     style="display:block;text-decoration:none;">
    <h2>Consumo estimado</h2>
    <div class="kpi-value" id="kpiConsumo">
      {{ consumo_total if consumo_total is not none else '--' }} L
    </div>
    <div class="kpi-helper">Ver histórico detalhado</div>
  </a>
  <div class="card-kpi col-4">
    <h2>Tensão bateria</h2>
    <div class="kpi-value" id="kpiTensao">0.00 V</div>
    <div class="kpi-helper" id="kpiTensaoInfo">--</div>
  </div>

  <div class="card-kpi col-4">
    <h2>Motor</h2>
    <div class="kpi-value" id="kpiMotor">--</div>
    <div class="status-row">
      <span class="status-dot" id="dotMotor"></span>
      <span id="kpiMotorHint" class="kpi-helper">--</span>
    </div>
  </div>

  <div class="card-kpi col-4">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Horas da embarcação</h2>
      <button class="tab-btn" id="btnAjustarHoras">Ajustar</button>
    </div>
    <div class="kpi-value" id="kpiHorasEmbarcacao">0.00 h</div>
    <div class="kpi-helper">Offset + motor</div>
  </div>

  <div class="card-kpi col-6">
    <h2>Localização</h2>
    <div class="kpi-helper" id="kpiLocalizacao">Latitude: -- — Longitude: --</div>
    <iframe id="mapFrame" class="map-frame"></iframe>
  </div>

  <div class="card-kpi col-6">
    <h2>Próximas atividades</h2>
    <div id="listaAtividadesPainel" class="kpi-helper">--</div>
  </div>

</section>

<!-- ===================== VIEW PREVENTIVA ===================== -->
<section id="viewPreventiva" class="grid-painel hidden">

  <div class="card-form col-6">
    <h3>Cadastrar atividade de preventiva</h3>
    <form id="formPlano">
      <!-- formulário mantido -->
    </form>
  </div>

  <div class="card-form col-6">
    <h3>Plano cadastrado</h3>
    <table class="table-mini">
      <thead>
        <tr>
          <th>Atividade</th>
          <th>Base</th>
          <th>Intervalo</th>
          <th>Primeira</th>
          <th>Avisar antes</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="planoBody"></tbody>
    </table>
  </div>

</section>

<!-- ===================== MODAL OFFSET ===================== -->
<div id="modalOffsetBg" class="modal-bg">
  <div class="modal">
    <h3>Ajustar horas da embarcação</h3>
    <input id="inputOffset" type="number" step="0.1">
    <div class="modal-btn-row">
      <button class="btn btn-secondary" id="btnCancelarOffset">Cancelar</button>
      <button class="btn btn-primary" id="btnSalvarOffset">Salvar</button>
    </div>
  </div>
</div>
<script>
  const ATIVO_ID = {{ ativo.id }};
  const ENDPOINT_DADOS = `/api/ativos/${ATIVO_ID}/dados`;
  const ENDPOINT_PREV = `/api/ativos/${ATIVO_ID}/preventiva`;
  const ENDPOINT_PLANO = `/api/ativos/${ATIVO_ID}/plano`;
  const ENDPOINT_OFFSET = `/api/ativos/${ATIVO_ID}/offset`;

  const viewPainel = document.getElementById("viewPainel");
  const viewPreventiva = document.getElementById("viewPreventiva");

  document.getElementById("btnTabPainel").onclick = () => {
    viewPainel.classList.remove("hidden");
    viewPreventiva.classList.add("hidden");
  };
  document.getElementById("btnTabPreventiva").onclick = () => {
    viewPreventiva.classList.remove("hidden");
    viewPainel.classList.add("hidden");
  };

  async function loadDados(){
    const r = await fetch(ENDPOINT_DADOS);
    const d = await r.json();

    document.getElementById("badgeImei").textContent = d.imei || "--";
    document.getElementById("kpiHorasMotor").textContent =
      Number(d.horas_motor ?? 0).toFixed(2) + " h";

    document.getElementById("kpiConsumo").textContent =
      d.consumo_total !== null ? Number(d.consumo_total).toFixed(2) + " L" : "-- L";
  }

  loadDados();
  setInterval(loadDados, 30000);
</script>

{% endblock %}
