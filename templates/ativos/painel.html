{% extends "base.html" %}
{% block title %}Painel do Ativo{% endblock %}

{% block content %}
<div class="page">

  <!-- ===================== STYLE ===================== -->
  <style>
    .painel-header-top{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:16px;flex-wrap:wrap;margin-bottom:12px;
    }
    .painel-titulo h1{
      margin:0;font-size:24px;font-weight:700;
    }
    .painel-titulo .sub{
      margin-top:4px;font-size:13px;color:#94a3b8;
    }
    .pill-strip{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .pill-badge{
      padding:6px 10px;border-radius:999px;font-size:12px;
      background:#020617;border:1px solid #1f2937;color:#e5e7eb;
    }

    .tab-row{
      display:flex;gap:10px;margin:20px 0;
    }
    .tab-btn{
      padding:10px 18px;border-radius:999px;font-size:14px;
      border:1px solid #1f2937;background:#0f172a;color:#e5e7eb;
      cursor:pointer;transition:.2s;
    }
    .tab-btn.active{
      color:#38bdf8;border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.3);
    }

    .grid-painel{
      display:grid;grid-template-columns:repeat(12,1fr);gap:16px;
    }
    @media (max-width:900px){
      .col-4{grid-column:span 12;}
      .col-6{grid-column:span 12;}
      .col-12{grid-column:span 12;}
    }
    @media (min-width:901px){
      .col-4{grid-column:span 4;}
      .col-6{grid-column:span 6;}
      .col-12{grid-column:span 12;}
    }

    .card-kpi,.card-form{
      background:#0b1220;border-radius:16px;
      border:1px solid #1f2937;padding:20px;
      box-shadow:0 10px 25px rgba(0,0,0,.3);
    }
    .card-kpi h2,.card-form h3{
      margin:0 0 10px;color:#38bdf8;font-size:15px;
      text-transform:uppercase;
    }
    .kpi-value{
      font-size:30px;font-weight:800;margin-bottom:6px;color:#e2e8f0;
    }
    .kpi-helper{
      font-size:13px;color:#9ca3af;
    }

    .status-row{
      display:flex;align-items:center;gap:8px;
      margin-top:6px;font-size:13px;
    }
    .status-dot{
      width:10px;height:10px;border-radius:999px;background:#4b5563;
    }
    .status-dot.ok{background:#22c55e;}
    .status-dot.bad{background:#ef4444;}

    .hidden{display:none;}

    .map-frame{
      width:100%;height:300px;border:0;border-radius:12px;margin-top:8px;
    }

    .form-grid{
      display:grid;grid-template-columns:repeat(12,1fr);gap:12px;
    }
    .form-field{
      display:flex;flex-direction:column;font-size:13px;color:#e5e7eb;
    }
    .form-field input,.form-field select{
      padding:8px;border-radius:8px;border:1px solid #1f2937;
      background:#0f172a;color:#e5e7eb;margin-top:4px;
    }
    .col-12x{grid-column:span 12;}
    .col-4x{grid-column:span 4;}

    .table-mini{
      width:100%;border-collapse:collapse;font-size:13px;margin-top:12px;
    }
    .table-mini th,.table-mini td{
      padding:8px;border-bottom:1px solid #1f2937;color:#e5e7eb;
    }
    .msg-inline{
      margin-top:10px;color:#94a3b8;font-size:13px;
    }

    .modal-bg{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.6);display:none;
      justify-content:center;align-items:center;z-index:9999;
    }
    .modal{
      background:#0f172a;padding:24px;border-radius:16px;width:350px;
      border:1px solid #1f2937;box-shadow:0 5px 20px rgba(0,0,0,.5);
    }
    .modal h3{
      margin:0 0 12px;color:#38bdf8;font-size:17px;
    }
    .modal input{
      width:100%;padding:10px;border-radius:10px;
      border:1px solid #1f2937;background:#0b1220;color:#fff;
      margin-bottom:12px;
    }
    .modal-btn-row{
      display:flex;justify-content:flex-end;gap:10px;
    }
    .btn{
      padding:8px 14px;border-radius:8px;font-size:14px;
      cursor:pointer;border:none;
    }
    .btn-primary{
      background:#38bdf8;color:#000;font-weight:600;
    }
    .btn-secondary{
      background:#1e293b;color:#e2e8f0;
    }

    .btn-excluir{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #991b1b;
      background:#1e293b;
      color:#ef4444;
      cursor:pointer;
    }
  </style>

  <!-- ===================== HEADER ===================== -->
  <div class="painel-header-top">
    <div class="painel-titulo">
      <h1>Painel — {{ ativo.nome }}</h1>
      <div class="sub">Ativo #{{ ativo.id }} — Cliente: {{ ativo.cliente.nome if ativo.cliente else '—' }}</div>
    </div>

    <div class="pill-strip">
      <div class="pill-badge" id="badgeUltima">Última: --</div>
      <div class="pill-badge"><span id="badgeIdentText">IMEI</span>: <span id="badgeImei">--</span></div>
    </div>
  </div>

  <!-- ===================== TABS ===================== -->
  <div class="tab-row">
    <button id="btnTabPainel" class="tab-btn active">Painel</button>
    <button id="btnTabPreventiva" class="tab-btn">Preventiva</button>
  </div>

  <!-- =========================================================
        VIEW PAINEL
  ========================================================== -->
  <section id="viewPainel" class="grid-painel">

    <div class="card-kpi col-4">
      <h2>Status monitoramento</h2>
      <div class="kpi-value" id="kpiMonitor">--</div>
      <div class="kpi-helper">Situação geral</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas motor</h2>
      <div class="kpi-value" id="kpiHorasMotor">0.00 h</div>
      <div class="kpi-helper">Total consolidado</div>
    </div>

    <!-- ✅ CARD CONSUMO ESTIMADO (TOTAL EM LITROS) -->
    <a href="/ativos/{{ ativo.id }}/consumo"
       class="card-kpi col-4"
       style="display:block;text-decoration:none;">
      <h2>Consumo estimado</h2>
      <div class="kpi-value" id="kpiConsumo">
        {{ consumo_total if consumo_total is not none else '--' }} L
      </div>
      <div class="kpi-helper">Ver histórico detalhado</div>
    </a>

    <div class="card-kpi col-4">
      <h2>Tensão bateria</h2>
      <div class="kpi-value" id="kpiTensao">0.00 V</div>
      <div class="kpi-helper" id="kpiTensaoInfo">--</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Motor</h2>
      <div class="kpi-value" id="kpiMotor">--</div>
      <div class="status-row">
        <span class="status-dot" id="dotMotor"></span>
        <span id="kpiMotorHint" class="kpi-helper">--</span>
      </div>
    </div>

    <div class="card-kpi col-4">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Horas da embarcação</h2>
        <button class="tab-btn" id="btnAjustarHoras">Ajustar</button>
      </div>
      <div class="kpi-value" id="kpiHorasEmbarcacao">0.00 h</div>
      <div class="kpi-helper">Offset + motor</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas paradas</h2>
      <div class="kpi-value" id="kpiHorasParadas">0.00 h</div>
      <div class="kpi-helper">Motor OFF</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Ignições</h2>
      <div class="kpi-value" id="kpiIgnicoes">0</div>
      <div class="kpi-helper">Vezes que ligou</div>
    </div>

    <div class="card-kpi col-6">
      <h2>Localização</h2>
      <div class="kpi-helper" id="kpiLocalizacao">Latitude: -- — Longitude: --</div>
      <iframe id="mapFrame" class="map-frame" src=""></iframe>
    </div>

    <div class="card-kpi col-6">
      <h2>Próximas atividades</h2>
      <div id="listaAtividadesPainel" class="kpi-helper">--</div>
    </div>

  </section>

  <!-- =========================================================
        VIEW PREVENTIVA
  ========================================================== -->
  <section id="viewPreventiva" class="grid-painel hidden">

    <div class="card-form col-6">
      <h3>Cadastrar atividade de preventiva</h3>

      <form id="formPlano" autocomplete="off">
        <div class="form-grid">
          <div class="form-field col-12x">
            <label>Nome da atividade</label>
            <input id="planoNome" type="text"/>
          </div>

          <div class="form-field col-4x">
            <label>Tipo de controle</label>
            <select id="planoBase">
              <option value="horas">Por horas</option>
              <option value="dias">Por dias</option>
            </select>
          </div>

          <div class="form-field col-4x">
            <label>Intervalo</label>
            <input id="planoIntervalo" type="number" step="0.1"/>
          </div>

          <div class="form-field col-4x">
            <label>Primeira execução</label>
            <input id="planoPrimeira" type="number" step="0.1"/>
          </div>

          <div class="form-field col-4x">
            <label>Avisar antes</label>
            <input id="planoAvisar" type="number" step="0.1"/>
          </div>

          <div class="form-field col-4x">
            <button class="btn-primary" type="submit">Adicionar</button>
          </div>
        </div>

        <div id="planoMsg" class="msg-inline"></div>
      </form>
    </div>

    <div class="card-form col-6">
      <h3>Plano cadastrado</h3>

      <table class="table-mini">
        <thead>
          <tr>
            <th>Atividade</th>
            <th>Base</th>
            <th>Intervalo</th>
            <th>Primeira</th>
            <th>Avisar antes</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="planoBody"></tbody>
      </table>

      <div id="planoEmpty" class="msg-inline">Nenhuma atividade cadastrada.</div>
    </div>

  </section>

</div>
<!-- ===================== MODAL AJUSTE DE OFFSET ===================== -->
<div id="modalOffsetBg" class="modal-bg">
  <div class="modal">
    <h3>Ajustar horas da embarcação</h3>
    <input id="inputOffset" type="number" step="0.1" placeholder="Digite o offset"/>
    <div class="modal-btn-row">
      <button class="btn btn-secondary" id="btnCancelarOffset">Cancelar</button>
      <button class="btn btn-primary" id="btnSalvarOffset">Salvar</button>
    </div>
  </div>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
  const ATIVO_ID = {{ ativo.id }};

  // ✅ endpoint correto (monitoramento) — atende IMEI (BrasilSat) e Tracker ID (Mobiltracker)
  const ENDPOINT_DADOS = `/api/monitoramento/${ATIVO_ID}/dados`;

  const ENDPOINT_PREV = `/api/ativos/${ATIVO_ID}/preventiva`;
  const ENDPOINT_PLANO = `/api/ativos/${ATIVO_ID}/plano`;
  const ENDPOINT_OFFSET = `/api/ativos/${ATIVO_ID}/offset`;

  const viewPainel = document.getElementById("viewPainel");
  const viewPreventiva = document.getElementById("viewPreventiva");
  const btnPainel = document.getElementById("btnTabPainel");
  const btnPreventiva = document.getElementById("btnTabPreventiva");

  // === helpers anti-NaN / anti-null ===
  function toNumber(val, fallback = null) {
    if (val === null || val === undefined) return fallback;
    if (typeof val === "string" && val.trim() === "") return fallback;
    const n = Number(val);
    return Number.isFinite(n) ? n : fallback;
  }
  function fmtFixed(val, digits = 2, fallbackText = "--") {
    const n = toNumber(val, null);
    if (n === null) return fallbackText;
    return n.toFixed(digits);
  }

  // ✅ NOVO: suporta Mobiltracker (timestamp ISO) e BrasilSat (servertime epoch seg)
  function parseTimestamp(d) {
    if (d && d.timestamp) {
      const dt = new Date(d.timestamp);
      return isNaN(dt.getTime()) ? null : dt;
    }
    if (d && d.servertime) {
      const dt = new Date(d.servertime * 1000);
      return isNaN(dt.getTime()) ? null : dt;
    }
    return null;
  }

  btnPainel.onclick = () => {
    btnPainel.classList.add("active");
    btnPreventiva.classList.remove("active");
    viewPainel.classList.remove("hidden");
    viewPreventiva.classList.add("hidden");
  };

  btnPreventiva.onclick = () => {
    btnPreventiva.classList.add("active");
    btnPainel.classList.remove("active");
    viewPainel.classList.add("hidden");
    viewPreventiva.classList.remove("hidden");
  };

  /* =============== MODAL OFFSET =============== */
  const modalBg = document.getElementById("modalOffsetBg");
  const btnAjustar = document.getElementById("btnAjustarHoras");
  const btnCancelar = document.getElementById("btnCancelarOffset");
  const btnSalvar = document.getElementById("btnSalvarOffset");
  const inputOffset = document.getElementById("inputOffset");

  btnAjustar.onclick = () => {
    inputOffset.value = "";
    modalBg.style.display = "flex";
  };

  btnCancelar.onclick = () => {
    modalBg.style.display = "none";
  };

  btnSalvar.onclick = async () => {
    const val = toNumber(inputOffset.value, null);
    if (val === null) {
      alert("Digite um número válido");
      return;
    }

    try {
      await fetch(ENDPOINT_OFFSET, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ offset: val })
      });
      modalBg.style.display = "none";
      loadDados();
    } catch (e) {
      console.error("Erro ao salvar offset:", e);
      alert("Erro ao salvar offset.");
    }
  };

  /* =============== CARREGAR DADOS DO PAINEL =============== */
  async function loadDados(){
    try{
      const r = await fetch(ENDPOINT_DADOS);
      if (!r.ok) throw new Error("HTTP " + r.status);
      const d = await r.json();

      // ✅ NOVO: Badge mostra Tracker ID quando for Mobiltracker, senão IMEI
      const identText = document.getElementById("badgeIdentText");
      const identVal = document.getElementById("badgeImei");
      if (d.tracking_provider === "mobiltracker") {
        identText.textContent = "Tracker ID";
        identVal.textContent = d.tracker_id || "--";
      } else {
        identText.textContent = "IMEI";
        identVal.textContent = d.imei || "--";
      }

      // ✅ NOVO: Última + online/offline suportando timestamp ISO e servertime epoch
      const dt = parseTimestamp(d);
      if (dt) {
        document.getElementById("badgeUltima").textContent =
          "Última: " + dt.toLocaleString("pt-BR", {hour12:false});

        const difMs = Date.now() - dt.getTime();
        const online = difMs < (5 * 60 * 1000);
        document.getElementById("kpiMonitor").textContent = online ? "online" : "offline";
      } else {
        document.getElementById("badgeUltima").textContent = "Última: --";
        document.getElementById("kpiMonitor").textContent = "--";
      }

      // ✅ NOVO: Mobiltracker não fornece motor_ligado (vem null) — não pintar como desligado
      if (d.motor_ligado === null || d.motor_ligado === undefined) {
        document.getElementById("kpiMotor").textContent = "--";
        document.getElementById("dotMotor").className = "status-dot";
        document.getElementById("kpiMotorHint").textContent = "--";
      } else {
        const motorOn = !!d.motor_ligado;
        document.getElementById("kpiMotor").textContent = motorOn ? "Ligado" : "Desligado";
        document.getElementById("dotMotor").className = "status-dot " + (motorOn ? "ok" : "bad");
        document.getElementById("kpiMotorHint").textContent = motorOn ? "Ignição ON" : "Ignição OFF";
      }

      const tensao = toNumber(d.tensao_bateria, 0);
      document.getElementById("kpiTensao").textContent = tensao.toFixed(2) + " V";
      let info = "—";
      if (tensao === 0) info = "Sem leitura";
      else if (tensao < 12.0) info = "Baixa";
      else if (tensao < 12.3) info = "Meia carga";
      else info = "OK";
      document.getElementById("kpiTensaoInfo").textContent = info;

      document.getElementById("kpiHorasMotor").textContent = fmtFixed(d.horas_motor, 2, "0.00") + " h";

      /* ✅ KPI: consumo estimado TOTAL (litros acumulados) — blindado contra NaN */
      const consumoTotal = toNumber(d.consumo_total, null);
      if (consumoTotal === null) {
        document.getElementById("kpiConsumo").textContent = "-- L";
      } else {
        document.getElementById("kpiConsumo").textContent = consumoTotal.toFixed(2) + " L";
      }

      document.getElementById("kpiHorasEmbarcacao").textContent = fmtFixed(d.horas_embarcacao, 2, "0.00") + " h";
      document.getElementById("kpiHorasParadas").textContent = fmtFixed(d.horas_paradas, 2, "0.00") + " h";
      document.getElementById("kpiIgnicoes").textContent = String(toNumber(d.ignicoes, 0));

      const lat = d.latitude;
      const lon = d.longitude;

      document.getElementById("kpiLocalizacao").textContent =
        `Latitude: ${lat ?? "--"} — Longitude: ${lon ?? "--"}`;

      const mapFrame = document.getElementById("mapFrame");
      if (lat !== null && lat !== undefined && lon !== null && lon !== undefined) {
        const url = `https://www.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
        if (mapFrame.src !== url) mapFrame.src = url;
      } else {
        mapFrame.src = "";
      }

    }catch(e){
      console.error("Erro ao carregar dados:", e);
    }
  }

  /* =============== EXCLUIR ATIVIDADE DO PLANO =============== */
  async function excluirPlano(id) {
    if (!confirm("Deseja excluir esta atividade?")) return;

    try {
      const r = await fetch(`${ENDPOINT_PLANO}/${id}`, { method: "DELETE" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      loadPlano();
      loadPreventiva();
    } catch (e) {
      console.error("Erro ao excluir plano:", e);
      alert("Erro ao excluir atividade.");
    }
  }

  /* =============== CARREGAR PLANO CADASTRADO =============== */
  async function loadPlano() {
    try {
      const r = await fetch(ENDPOINT_PLANO);
      if (!r.ok) throw new Error("HTTP " + r.status);

      const d = await r.json();
      const list = d.plano || [];

      const tbody = document.getElementById("planoBody");
      const emptyMsg = document.getElementById("planoEmpty");

      if (list.length === 0) {
        tbody.innerHTML = "";
        emptyMsg.style.display = "block";
        return;
      }

      emptyMsg.style.display = "none";
      tbody.innerHTML = list.map(t => `
        <tr>
          <td>${t.nome}</td>
          <td>${t.base}</td>
          <td>${t.intervalo}</td>
          <td>${t.primeira_execucao}</td>
          <td>${t.avisar_antes}</td>
          <td>
            <button class="btn-excluir" onclick="excluirPlano(${t.id})">Excluir</button>
          </td>
        </tr>
      `).join("");

    } catch (e) {
      console.error("Erro ao carregar plano:", e);
    }
  }
  /* =============== CARREGAR PRÓXIMAS PREVENTIVAS =============== */
  async function loadPreventiva(){
    try{
      const r = await fetch(ENDPOINT_PREV);
      if (!r.ok) throw new Error("HTTP " + r.status);
      const d = await r.json();
      const list = d.tarefas || [];

      const render = (arr, target) => {
        target.innerHTML = arr.length
          ? arr.map(t => `• ${t.nome} (${Number(t.faltam ?? 0).toFixed(1)} ${t.base === 'dias' ? 'd' : 'h'})`).join("<br>")
          : "--";
      };

      render(list, document.getElementById("listaAtividadesPainel"));
      render(list, document.getElementById("listaAtividadesPrev"));

    }catch(e){
      console.error("Erro preventiva:", e);
    }
  }

  /* =============== ATIVAÇÃO =============== */
  loadDados();
  loadPlano();
  loadPreventiva();

  setInterval(() => {
    loadDados();
    loadPlano();
    loadPreventiva();
  }, 30000);

  /* =============== SUBMIT DO FORM =============== */
  document.getElementById("formPlano").onsubmit = async (ev) => {
    ev.preventDefault();

    const nome = document.getElementById("planoNome").value.trim();
    const base = document.getElementById("planoBase").value;
    const intervalo = parseFloat(document.getElementById("planoIntervalo").value);
    const primeira = parseFloat(document.getElementById("planoPrimeira").value);
    const avisar = parseFloat(document.getElementById("planoAvisar").value);

    if (!nome) {
      alert("Nome obrigatório");
      return;
    }

    try {
      await fetch(ENDPOINT_PLANO, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          nome,
          base,
          intervalo,
          primeira_execucao: primeira,
          avisar_antes: avisar
        })
      });

      document.getElementById("planoMsg").textContent =
        "Atividade adicionada com sucesso.";

      loadPlano();
      loadPreventiva();

    } catch (e) {
      console.error("Erro ao adicionar plano:", e);
      alert("Erro ao criar atividade.");
    }
  };
</script>

{% endblock %}
