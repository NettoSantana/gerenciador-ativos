{% extends "base.html" %}
{% block title %}Painel do Ativo{% endblock %}

{% block content %}
<div class="page">

  <style>
    .painel-header-top{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:16px;flex-wrap:wrap;margin-bottom:12px;
    }
    .painel-titulo h1{
      margin:0;font-size:24px;
    }
    .painel-titulo .sub{
      margin-top:4px;font-size:13px;color:#94a3b8;
    }
    .pill-strip{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .pill-badge{
      padding:6px 10px;border-radius:999px;font-size:12px;
      background:#020617;border:1px solid #1f2937;color:#e5e7eb;
    }
    .pill-badge.muted{color:#9ca3af;}
    .tab-row{
      display:flex;gap:8px;margin-bottom:20px;
    }
    .tab-btn{
      padding:8px 16px;border-radius:999px;font-size:13px;
      border:1px solid #1f2937;background:#020617;color:#e5e7eb;
      cursor:pointer;
    }
    .tab-btn.active{
      border-color:#38bdf8;
      color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.3);
    }

    .grid-painel{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:16px;
    }
    @media (max-width:900px){
      .grid-painel{grid-template-columns:repeat(6,1fr);}
      .col-4{grid-column:span 6;}
      .col-6{grid-column:span 6;}
      .col-12{grid-column:span 6;}
    }
    @media (min-width:901px){
      .col-4{grid-column:span 4;}
      .col-6{grid-column:span 6;}
      .col-12{grid-column:span 12;}
    }

    .card-kpi{
      background:linear-gradient(180deg,#020617,#020617);
      border-radius:16px;
      border:1px solid #1f2937;
      padding:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.6);
    }
    .card-kpi h2{
      margin:0 0 10px;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#38bdf8;
    }
    .kpi-value{
      font-size:30px;
      font-weight:800;
      margin-bottom:6px;
    }
    .kpi-helper{
      font-size:13px;
      color:#9ca3af;
    }
    .status-row{
      display:flex;align-items:center;gap:8px;margin-top:6px;font-size:13px;
    }
    .status-dot{
      width:10px;height:10px;border-radius:999px;background:#4b5563;
    }
    .status-dot.ok{background:#22c55e;}
    .status-dot.bad{background:#ef4444;}
    .status-dot.warn{background:#eab308;}

    .hidden{display:none;}

    /* MAPA */
    .map-wrapper{
      margin-top:10px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #1f2937;
    }
    .map-frame{
      width:100%;
      height:260px;
      border:0;
    }

    /* MODAL AJUSTE */
    #modalAjuste{
      display:none;position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.6);justify-content:center;align-items:center;
      z-index:9999;
    }
  </style>

  <!-- ======================
        CABEÇALHO
  ======================= -->
  <div class="painel-header-top">
    <div class="painel-titulo">
      <h1>Painel — {{ ativo.nome }}</h1>
      <div class="sub">
        Ativo #{{ ativo.id }} — Cliente: {{ ativo.cliente.nome if ativo.cliente else '—' }}
      </div>
    </div>
    <div class="pill-strip">
      <div class="pill-badge" id="badgeUltima">Última: --</div>
      <div class="pill-badge">IMEI: <span id="badgeImei">--</span></div>
    </div>
  </div>

  <!-- ======================
        TABS
  ======================= -->
  <div class="tab-row">
    <button id="btnTabPainel" class="tab-btn active">Painel</button>
  </div>

  <!-- ======================
        PAINEL
  ======================= -->
  <section id="viewPainel" class="grid-painel">

    <div class="card-kpi col-4">
      <h2>Status monitoramento</h2>
      <div class="kpi-value" id="kpiMonitor">--</div>
      <div class="kpi-helper">Situação geral</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas de motor</h2>
      <div class="kpi-value" id="kpiHorasMotor">0.00 h</div>
      <div class="kpi-helper">Total consolidado (rastreador)</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Tensão bateria</h2>
      <div class="kpi-value" id="kpiTensao">0.00 V</div>
      <div class="kpi-helper" id="kpiTensaoInfo">--</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Motor</h2>
      <div class="kpi-value" id="kpiMotor">--</div>
      <div class="status-row">
        <span class="status-dot" id="dotMotor"></span>
        <span id="kpiMotorHint" class="kpi-helper">--</span>
      </div>
    </div>

    <div class="card-kpi col-4">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Horas da embarcação</h2>
        <button class="btn-primary-sm" id="btnAjustarHoras"
          style="padding:6px 10px; font-size:12px; margin-top:0;">
          Ajustar
        </button>
      </div>
      <div class="kpi-value" id="kpiHorasEmbarcacao">0.00 h</div>
      <div class="kpi-helper">Offset + horas de motor</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas paradas</h2>
      <div class="kpi-value" id="kpiHorasParadas">0.00 h</div>
      <div class="kpi-helper">Acumulado em motor desligado</div>
    </div>

    <div class="card-kpi col-6">
      <h2>Localização</h2>
      <div class="kpi-helper" id="kpiLocalizacao">Latitude: -- — Longitude: --</div>
      <div class="map-wrapper">
        <iframe id="mapFrame" class="map-frame" src=""></iframe>
      </div>
    </div>

  </section>

</div>

<!-- ======================
      MODAL AJUSTE OFFSET
======================= -->
<div id="modalAjuste">
  <div style="background:#020617;padding:20px;border-radius:12px;width:300px;
              border:1px solid #1f2937;">

    <h3 style="margin-top:0;color:#e5e7eb;">Ajustar Offset</h3>

    <label style="color:#9ca3af;font-size:13px;">Offset (horas)</label>
    <input id="inputOffset" type="number" step="0.1"
           style="width:100%;margin-top:6px;padding:8px;border-radius:8px;
                  background:#0b1020;border:1px solid #1f2937;color:#e5e7eb;">

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
      <button id="btnModalCancelar" class="btn-primary-sm" style="background:#64748b;">Cancelar</button>
      <button id="btnModalSalvar" class="btn-primary-sm">Salvar</button>
    </div>

    <div id="modalMsg" style="margin-top:8px;font-size:12px;color:#38bdf8;"></div>
  </div>
</div>

<!-- ======================
      SCRIPT
======================= -->
<script>
  const ATIVO_ID = {{ ativo.id }};
  const ENDPOINT_DADOS = `/api/ativos/${ATIVO_ID}/dados`;   // <--- CORRETÍSSIMO

  const mapFrame = document.getElementById("mapFrame");

  function fmtHora(ts){
    try{
      return new Date(ts*1000).toLocaleString("pt-BR",{hour12:false});
    }catch{
      return "--";
    }
  }

  async function loadDados(){
    try{
      const r = await fetch(ENDPOINT_DADOS);
      const d = await r.json();

      document.getElementById("badgeImei").textContent = d.imei || "--";
      document.getElementById("badgeUltima").textContent = "Última: " + fmtHora(d.servertime);

      document.getElementById("kpiMonitor").textContent = d.monitor_online ? "online" : "offline";

      document.getElementById("kpiMotor").textContent = d.motor_ligado ? "Ligado" : "Desligado";
      document.getElementById("dotMotor").className = "status-dot " + (d.motor_ligado ? "ok" : "bad");
      document.getElementById("kpiMotorHint").textContent = d.motor_ligado ? "Ignição ON" : "Ignição OFF";

      document.getElementById("kpiHorasMotor").textContent = `${(d.horas_motor ?? 0).toFixed(2)} h`;
      document.getElementById("kpiHorasEmbarcacao").textContent = `${(d.hora_embarcacao ?? 0).toFixed(2)} h`;
      document.getElementById("kpiHorasParadas").textContent = `${(d.horas_paradas ?? 0).toFixed(2)} h`;

      const tensao = Number(d.tensao_bateria || 0);
      document.getElementById("kpiTensao").textContent = tensao.toFixed(2) + " V";

      let info = "--";
      if(tensao === 0) info = "Sem leitura";
      else if(tensao < 12.0) info = "Baixa";
      else if(tensao < 12.3) info = "Meia carga";
      else info = "OK";
      document.getElementById("kpiTensaoInfo").textContent = info;

      const lat = d.latitude;
      const lon = d.longitude;

      document.getElementById("kpiLocalizacao").textContent =
        `Latitude: ${lat ?? "--"} — Longitude: ${lon ?? "--"}`;

      if(lat && lon){
        const url = `https://www.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
        if(mapFrame.src !== url){
          mapFrame.src = url;
        }
      }
    }catch(e){
      console.warn("Erro carregando dados", e);
    }
  }

  // Carregar imediatamente
  loadDados();
  setInterval(loadDados, 30000);

  // Modal ajuste (mantido)
  const modal = document.getElementById("modalAjuste");
  const inputOffset = document.getElementById("inputOffset");
  const btnSalvar = document.getElementById("btnModalSalvar");
  const btnCancelar = document.getElementById("btnModalCancelar");
  const btnAjustar = document.getElementById("btnAjustarHoras");

  btnAjustar.onclick = () => {
    modal.style.display = "flex";
    inputOffset.value = "";
  };

  btnCancelar.onclick = () => {
    modal.style.display = "none";
  };

  btnSalvar.onclick = async () => {
    const valor = parseFloat(inputOffset.value || "0");

    try{
      const r = await fetch(`/api/ativos/${ATIVO_ID}/ajustar-horas`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ offset: valor })
      });

      modal.style.display = "none";
      loadDados();
    }catch(e){
      console.log("Erro ao salvar offset", e);
    }
  };
</script>

{% endblock %}
