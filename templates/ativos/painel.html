{% extends "base.html" %}
{% block title %}Painel do Ativo{% endblock %}

{% block content %}
<div class="page">

  <style>
    .painel-header-top{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:16px;flex-wrap:wrap;margin-bottom:12px;
    }
    .painel-titulo h1{
      margin:0;font-size:24px;
    }
    .painel-titulo .sub{
      margin-top:4px;font-size:13px;color:#94a3b8;
    }
    .pill-strip{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .pill-badge{
      padding:6px 10px;border-radius:999px;font-size:12px;
      background:#020617;border:1px solid #1f2937;color:#e5e7eb;
    }
    .pill-badge.muted{color:#9ca3af;}

    .tab-row{
      display:flex;gap:8px;margin:16px 0 20px;
      border-bottom:1px solid #111827;
      padding-bottom:4px;
    }
    .tab-btn{
      padding:8px 16px;border-radius:999px;font-size:13px;
      border:none;background:transparent;color:#9ca3af;
      cursor:pointer;
    }
    .tab-btn.active{
      color:#38bdf8;
      background:rgba(56,189,248,0.1);
      box-shadow:0 0 0 1px rgba(56,189,248,.3);
    }

    .grid-painel{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:16px;
    }
    @media (max-width:900px){
      .grid-painel{grid-template-columns:repeat(6,1fr);}
      .col-4{grid-column:span 6;}
      .col-6{grid-column:span 6;}
      .col-12{grid-column:span 6;}
    }
    @media (min-width:901px){
      .col-4{grid-column:span 4;}
      .col-6{grid-column:span 6;}
      .col-12{grid-column:span 12;}
    }

    .card-kpi,
    .card-form{
      background:linear-gradient(180deg,#020617,#020617);
      border-radius:16px;
      border:1px solid #1f2937;
      padding:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.6);
    }
    .card-kpi h2,
    .card-form h3{
      margin:0 0 10px;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#38bdf8;
    }
    .kpi-value{
      font-size:30px;
      font-weight:800;
      margin-bottom:6px;
    }
    .kpi-helper{
      font-size:13px;
      color:#9ca3af;
    }
    .status-row{
      display:flex;align-items:center;gap:8px;margin-top:6px;font-size:13px;
    }
    .status-dot{
      width:10px;height:10px;border-radius:999px;background:#4b5563;
    }
    .status-dot.ok{background:#22c55e;}
    .status-dot.bad{background:#ef4444;}
    .status-dot.warn{background:#eab308;}

    .map-wrapper{
      margin-top:10px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #111827;
      background:#020617;
      min-height:180px;
    }
    .map-frame{
      width:100%;
      height:220px;
      border:0;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:12px;
      margin-top:8px;
    }
    .form-field{
      display:flex;flex-direction:column;gap:4px;
      font-size:13px;
    }
    .form-field label{
      color:#e5e7eb;font-size:13px;
    }
    .form-field input,
    .form-field select{
      background:#020617;
      border-radius:8px;
      border:1px solid #1f2937;
      padding:6px 10px;
      color:#e5e7eb;
      font-size:13px;
    }
    .col-12x{grid-column:span 12;}
    .col-4x{grid-column:span 4;}
    @media(max-width:900px){
      .col-4x{grid-column:span 6;}
      .col-12x{grid-column:span 12;}
    }

    .btn-primary-sm{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;
      border:none;
      padding:7px 14px;
      font-size:12px;
      font-weight:500;
      background:#38bdf8;
      color:#020617;
      cursor:pointer;
    }
    .btn-primary-sm:hover{
      background:#0ea5e9;
    }

    .table-mini{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .table-mini th,
    .table-mini td{
      padding:6px 8px;
      border-bottom:1px solid #111827;
    }
    .table-mini th{
      text-align:left;
      color:#9ca3af;
      font-weight:500;
    }

    .msg-inline{
      margin-top:8px;
      font-size:13px;
      color:#9ca3af;
    }

    .badge-chip{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#020617;
      border:1px solid #1f2937;
    }

    .hidden{display:none;}
  </style>

  <!-- =======================
        CABEÇALHO
  ======================== -->
  <div class="painel-header-top">
    <div class="painel-titulo">
      <h1>Painel — {{ ativo.nome }}</h1>
      <div class="sub">
        Ativo #{{ ativo.id }} — Cliente: {{ ativo.cliente.nome if ativo.cliente else '—' }}
      </div>
    </div>
    <div class="pill-strip">
      <div class="pill-badge" id="badgeUltima">Última: --</div>
      <div class="pill-badge">IMEI: <span id="badgeImei">--</span></div>
    </div>
  </div>

  <!-- =======================
        TABS
  ======================== -->
  <div class="tab-row">
    <button id="btnTabPainel" class="tab-btn active">Painel</button>
    <button id="btnTabPreventiva" class="tab-btn">Preventiva</button>
  </div>

  <!-- =======================
        VIEW PAINEL
  ======================== -->
  <section id="viewPainel" class="grid-painel">

    <div class="card-kpi col-4">
      <h2>Status monitoramento</h2>
      <div class="kpi-value" id="kpiMonitor">--</div>
      <div class="kpi-helper">Situação geral</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas de motor</h2>
      <div class="kpi-value" id="kpiHorasMotor">0.00 h</div>
      <div class="kpi-helper">Total consolidado (rastreador)</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Tensão bateria</h2>
      <div class="kpi-value" id="kpiTensao">0.00 V</div>
      <div class="kpi-helper" id="kpiTensaoInfo">--</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Motor</h2>
      <div class="kpi-value" id="kpiMotor">--</div>
      <div class="status-row">
        <span class="status-dot" id="dotMotor"></span>
        <span id="kpiMotorHint" class="kpi-helper">--</span>
      </div>
    </div>

    <div class="card-kpi col-4">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Horas da embarcação</h2>
        <button class="btn-primary-sm" id="btnAjustarHoras" style="margin-top:0;">
          Ajustar
        </button>
      </div>
      <div class="kpi-value" id="kpiHorasEmbarcacao">0.00 h</div>
      <div class="kpi-helper">Offset + horas de motor</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Horas paradas</h2>
      <div class="kpi-value" id="kpiHorasParadas">0.00 h</div>
      <div class="kpi-helper">Acumulado em motor desligado</div>
    </div>

    <div class="card-kpi col-4">
      <h2>Ignições</h2>
      <div class="kpi-value" id="kpiIgnicoes">0</div>
      <div class="kpi-helper">Vezes que o motor ligou</div>
    </div>

    <div class="card-kpi col-6">
      <h2>Localização</h2>
      <div class="kpi-helper" id="kpiLocalizacao">Latitude: -- — Longitude: --</div>
      <div class="map-wrapper">
        <iframe id="mapFrame" class="map-frame" src="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>

    <div class="card-kpi col-6">
      <h2>Próximas atividades</h2>
      <div id="listaAtividadesPainel" class="kpi-helper">--</div>
    </div>

  </section>

  <!-- ============================
        VIEW PREVENTIVA
  ============================= -->
  <section id="viewPreventiva" class="grid-painel hidden">

    <div class="card-kpi col-6">
      <h2>Próximas atividades</h2>
      <div id="listaAtividadesPrev" class="kpi-helper">--</div>
    </div>

    <div class="card-form col-6">
      <h3>Cadastrar atividade de preventiva</h3>

      <form id="formPlano" autocomplete="off">
        <div class="form-grid">
          <div class="form-field col-12x">
            <label for="planoNome">Nome da atividade</label>
            <input id="planoNome" type="text" placeholder="Ex.: Troca de óleo do motor" />
          </div>

          <div class="form-field col-4x">
            <label for="planoBase">Tipo de controle</label>
            <select id="planoBase">
              <option value="horas" selected>Por horas de motor</option>
              <option value="dias">Por dias corridos</option>
            </select>
          </div>

          <div class="form-field col-4x">
            <label for="planoIntervalo">Intervalo</label>
            <input id="planoIntervalo" type="number" step="0.1" min="0" placeholder="Ex.: 100" />
          </div>

          <div class="form-field col-4x">
            <label for="planoPrimeira">Primeira execução</label>
            <input id="planoPrimeira" type="number" step="0.1" min="0" placeholder="Opcional" />
          </div>

          <div class="form-field col-4x">
            <label for="planoAvisar">Avisar antes</label>
            <input id="planoAvisar" type="number" step="0.1" min="0" placeholder="Opcional" />
          </div>

          <div class="form-field col-4x" style="align-self:flex-end;">
            <button type="submit" class="btn-primary-sm">Adicionar atividade</button>
          </div>
        </div>

        <div id="planoMsg" class="msg-inline"></div>
      </form>
    </div>

    <div class="card-form col-12">
      <h3>Plano cadastrado</h3>
      <table class="table-mini">
        <thead>
          <tr>
            <th>Atividade</th>
            <th>Base</th>
            <th>Intervalo</th>
            <th>Primeira</th>
            <th>Avisar antes</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="planoBody"></tbody>
      </table>

      <div id="planoEmpty" class="msg-inline">
        Nenhuma atividade cadastrada. Serão usadas as regras padrão.
      </div>
    </div>

  </section>

</div>

<!-- ====================================================
      SCRIPT PRINCIPAL
==================================================== -->
<script>
  const ATIVO_ID = {{ ativo.id }};
  const ENDPOINT_DADOS = `/api/ativos/${ATIVO_ID}/dados-v2`;
  const ENDPOINT_PREV = `/api/ativos/${ATIVO_ID}/preventiva`;
  const ENDPOINT_PLANO = `/api/ativos/${ATIVO_ID}/plano`;

  const mapFrame = document.getElementById("mapFrame");

  const btnTabPainel = document.getElementById("btnTabPainel");
  const btnTabPreventiva = document.getElementById("btnTabPreventiva");
  const viewPainel = document.getElementById("viewPainel");
  const viewPreventiva = document.getElementById("viewPreventiva");

  function setTab(tab){
    if(tab === "painel"){
      btnTabPainel.classList.add("active");
      btnTabPreventiva.classList.remove("active");
      viewPainel.classList.remove("hidden");
      viewPreventiva.classList.add("hidden");
    }else{
      btnTabPainel.classList.remove("active");
      btnTabPreventiva.classList.add("active");
      viewPainel.classList.add("hidden");
      viewPreventiva.classList.remove("hidden");
    }
  }

  btnTabPainel.addEventListener("click",()=>setTab("painel"));
  btnTabPreventiva.addEventListener("click",()=>setTab("preventiva"));

  function fmtHora(ts){
    try{
      return new Date(ts*1000).toLocaleString("pt-BR",{hour12:false});
    }catch(e){
      return "--";
    }
  }

  async function loadDados(){
    try{
      const r = await fetch(ENDPOINT_DADOS);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const d = await r.json();

      document.getElementById("badgeImei").textContent = d.imei || "--";
      document.getElementById("badgeUltima").textContent = "Última: " + fmtHora(d.servertime);

      const on = !!d.monitor_online;
      document.getElementById("kpiMonitor").textContent = on ? "online" : "offline";

      const motorOn = !!d.motor_ligado;
      document.getElementById("kpiMotor").textContent = motorOn ? "Ligado" : "Desligado";
      document.getElementById("dotMotor").className = "status-dot " + (motorOn ? "ok" : "bad");
      document.getElementById("kpiMotorHint").textContent = motorOn ? "Ignição ON" : "Ignição OFF";

      const tensao = Number(d.tensao_bateria || 0);
      document.getElementById("kpiTensao").textContent = tensao.toFixed(2) + " V";

      let info = "—";
      if(tensao === 0) info = "Sem leitura";
      else if(tensao < 12.0) info = "Baixa";
      else if(tensao < 12.3) info = "Meia carga";
      else info = "OK";
      document.getElementById("kpiTensaoInfo").textContent = info;

      const hMotor = Number(d.horas_motor || 0);
      document.getElementById("kpiHorasMotor").textContent = hMotor.toFixed(2) + " h";

      const hEmb = Number(d.hora_embarcacao || 0);
      document.getElementById("kpiHorasEmbarcacao").textContent = hEmb.toFixed(2) + " h";

      const hParadas = Number(d.horas_paradas || 0);
      document.getElementById("kpiHorasParadas").textContent = hParadas.toFixed(2) + " h";

      const ign = Number(d.ignicoes || 0);
      document.getElementById("kpiIgnicoes").textContent = ign.toString();

      const lat = d.latitude;
      const lon = d.longitude;

      document.getElementById("kpiLocalizacao").textContent =
        `Latitude: ${lat ?? "--"} — Longitude: ${lon ?? "--"}`;

      if(lat && lon){
        const url = `https://www.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
        if(mapFrame.src !== url){
          mapFrame.src = url;
        }
      } else {
        mapFrame.src = "";
      }

    }catch(e){
      console.error("Erro ao carregar dados:", e);
    }
  }

  async function loadPreventiva(){
    try{
      const r = await fetch(ENDPOINT_PREV);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const d = await r.json();
      const tarefas = d.tarefas || [];

      const render = (lista, target) => {
        if(!lista.length){
          target.innerHTML = "--";
          return;
        }
        target.innerHTML = lista
          .slice(0,5)
          .map(t => `• ${t.nome} (${t.faltam.toFixed(1)} ${t.base === "dias" ? "d" : "h"})`)
          .join("<br>");
      };

      render(tarefas, document.getElementById("listaAtividadesPainel"));
      render(tarefas, document.getElementById("listaAtividadesPrev"));

    }catch(e){
      console.error("Erro preventiva:", e);
    }
  }

  async function loadPlano(){
    try{
      const r = await fetch(ENDPOINT_PLANO);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const d = await r.json();
      const itens = d.itens || [];

      const body = document.getElementById("planoBody");
      const empty = document.getElementById("planoEmpty");

      if(!itens.length){
        body.innerHTML = "";
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";
      body.innerHTML = itens.map(item => `
        <tr>
          <td>${item.nome}</td>
          <td><span class="badge-chip">${item.base}</span></td>
          <td>${item.intervalo}</td>
          <td>${item.primeira ?? "—"}</td>
          <td>${item.avisar ?? "—"}</td>
          <td>
            <button type="button" class="btn-primary-sm btn-remove-plano" data-id="${item.id}">
              Remover
            </button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll(".btn-remove-plano").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if(!id) return;
          if(!confirm("Remover esta atividade?")) return;

          try{
            const resp = await fetch(`${ENDPOINT_PLANO}/${id}`, { method:"DELETE" });
            if(!resp.ok) throw new Error("HTTP "+resp.status);
            await loadPlano();
            await loadPreventiva();
          }catch(e){
            console.error("Erro ao remover item do plano:", e);
            alert("Erro ao remover atividade.");
          }
        });
      });

    }catch(e){
      console.error("Erro ao carregar plano:", e);
    }
  }

  document.getElementById("formPlano").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const msg = document.getElementById("planoMsg");
    msg.textContent = "";

    const nome = document.getElementById("planoNome").value.trim();
    const base = document.getElementById("planoBase").value;
    const intervalo = Number(document.getElementById("planoIntervalo").value);
    const primeiraRaw = document.getElementById("planoPrimeira").value;
    const avisarRaw = document.getElementById("planoAvisar").value;

    if(!nome || !intervalo || intervalo <= 0){
      msg.textContent = "Informe pelo menos o nome e o intervalo.";
      return;
    }

    const payload = {
      nome,
      base,
      intervalo,
      primeira: primeiraRaw ? Number(primeiraRaw) : null,
      avisar: avisarRaw ? Number(avisarRaw) : null,
    };

    try{
      const resp = await fetch(ENDPOINT_PLANO, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload),
      });
      if(!resp.ok){
        const txt = await resp.text();
        console.error("Erro plano:", resp.status, txt);
        throw new Error("HTTP "+resp.status);
      }

      document.getElementById("planoNome").value = "";
      document.getElementById("planoIntervalo").value = "";
      document.getElementById("planoPrimeira").value = "";
      document.getElementById("planoAvisar").value = "";

      msg.textContent = "Atividade adicionada com sucesso.";
      await loadPlano();
      await loadPreventiva();

    }catch(e){
      console.error("Erro ao salvar plano:", e);
      msg.textContent = "Erro ao salvar atividade. Tente novamente.";
    }
  });

  // Botão AJUSTAR – por enquanto só coleta o valor e deixa pronto
  // pra chamar o endpoint de ajuste (vamos fazer isso no próximo passo).
  document.getElementById("btnAjustarHoras").addEventListener("click", async ()=>{
    const atualTxt = document.getElementById("kpiHorasEmbarcacao").textContent.replace(" h","").trim();
    const valorStr = prompt("Informe a hora atual da embarcação (horímetro do painel):", atualTxt || "");
    if(valorStr === null) return;

    const valor = Number((valorStr || "").replace(",","."));
    if(isNaN(valor) || valor < 0){
      alert("Valor inválido.");
      return;
    }

    // TODO: ligar em um endpoint tipo POST /api/ativos/<id>/ajustar-horas
    console.log("Valor informado para ajuste de horímetro:", valor);

    alert("Valor registrado. No próximo passo vamos persistir isso no servidor.");
  });

  // Carga inicial
  loadDados();
  loadPreventiva();
  loadPlano();

  // Refresh periódico
  setInterval(() => {
    loadDados();
    loadPreventiva();
  }, 30000);
</script>

{% endblock %}