{% extends "base.html" %}
{% block title %}{{ ativo.nome }} — Painel Interno{% endblock %}

{% block content %}
<div class="page">

  <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0;">{{ ativo.nome }}</h1>
      <p style="margin:4px 0 0; color:#94a3b8;">
        Cliente: {{ ativo.cliente.nome if ativo.cliente else '—' }}
      </p>
    </div>

    <a href="{{ url_for('ativos.lista') }}" class="btn-ghost">← Voltar</a>
  </div>

  <div style="margin-bottom:18px; display:flex; justify-content:flex-end; gap:8px;">
    <button id="btn-atualizar" class="btn-primary" type="button">
      Atualizar dados
    </button>
  </div>

  <!-- GRID DE CARDS PRINCIPAIS -->
  <div class="cards-grid"
       style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-bottom:20px;">

    <!-- STATUS -->
    <div class="card" style="padding:16px;">
      <h2>Status monitoramento</h2>
      <p id="status-monitoramento-texto" style="margin:0; font-size:1.4rem;">
        {{ ativo.status_monitoramento or '—' }}
      </p>
      <small style="color:#94a3b8;">Situação geral</small>
    </div>

    <!-- HORAS DE MOTOR -->
    <div class="card" style="padding:16px;">
      <h2>Horas de Motor</h2>
      <p id="horas-motor-texto" style="margin:0; font-size:2rem; font-weight:600;">
        {{ "%.1f"|format(ativo.horas_motor or 0.0) }} h
      </p>
      <small style="color:#94a3b8;">Total consolidado</small>
    </div>

    <!-- TENSÃO BATERIA -->
    <div class="card" style="padding:16px;">
      <h2>Tensão Bateria</h2>
      <p id="tensao-bateria-texto" style="margin:0; font-size:2rem; font-weight:600;">
        {% if ativo.tensao_bateria %}
          {{ "%.1f"|format(ativo.tensao_bateria) }} V
        {% else %}
          —
        {% endif %}
      </p>
      <small style="color:#94a3b8;">Última leitura</small>
    </div>

    <!-- MOTOR LIGADO -->
    <div class="card" style="padding:16px;">
      <h2>Motor</h2>
      <p id="motor-ligado-texto" style="margin:0; font-size:1.6rem; font-weight:600;">
        —
      </p>
      <small style="color:#94a3b8;">Ignition (ACC)</small>
    </div>

    <!-- HORAS PARADAS (MESMO QUE O CLIENTE VÊ) -->
    <div class="card" style="padding:16px;">
      <h2>Horas Paradas</h2>
      <p id="horas-paradas-texto" style="margin:0; font-size:2rem; font-weight:600;">
        {{ "%.1f"|format(ativo.horas_paradas or 0.0) }} h
      </p>
      <small style="color:#94a3b8;">Estimado</small>
    </div>

    <!-- ÚLTIMA ATUALIZAÇÃO -->
    <div class="card" style="padding:16px;">
      <h2>Última Atualização</h2>
      <p id="ultima-atualizacao-texto" style="margin:0; font-size:1.1rem;">
        {% if ativo.ultima_atualizacao %}
          {{ ativo.ultima_atualizacao }}
        {% else %}
          nunca
        {% endif %}
      </p>
      <small style="color:#94a3b8;">Horário do rastreador</small>
    </div>

  </div>

  <!-- LOCALIZAÇÃO / MAPA -->
  <div class="card" style="padding:16px; margin-bottom:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div>
        <h2 style="margin:0;">Localização da embarcação</h2>
        <p id="coords-texto" style="margin:4px 0 0; color:#94a3b8; font-size:0.9rem;">
          Aguardando atualização de telemetria...
        </p>
      </div>
    </div>

    <!-- CSS/JS do Leaflet (mapa) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <div id="map" style="width:100%; height:320px; border-radius:12px; overflow:hidden; margin-top:8px;"></div>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin="">
    </script>
  </div>

  <!-- MENSAGEM / DEBUG -->
  <div id="monitoramento-mensagem"
       class="card"
       style="padding:14px; display:none; font-size:0.9rem; color:#94a3b8;">
  </div>

</div>

<script>
(function () {
  const ativoId = {{ ativo.id }};

  const btn = document.getElementById("btn-atualizar");
  const statusEl = document.getElementById("status-monitoramento-texto");
  const horasEl = document.getElementById("horas-motor-texto");
  const tensaoEl = document.getElementById("tensao-bateria-texto");
  const motorEl = document.getElementById("motor-ligado-texto");
  const ultimaEl = document.getElementById("ultima-atualizacao-texto");
  const msgEl = document.getElementById("monitoramento-mensagem");
  const coordsEl = document.getElementById("coords-texto");

  let map = null;
  let marker = null;

  function msg(texto, tipo="info") {
    msgEl.style.display = "block";
    msgEl.textContent = texto;

    if (tipo === "erro") msgEl.style.color = "#fca5a5";
    else if (tipo === "ok") msgEl.style.color = "#6ee7b7";
    else msgEl.style.color = "#94a3b8";
  }

  function initMapIfNeeded() {
    if (map) return;
    if (typeof L === "undefined") {
      console.warn("Leaflet não carregado, mapa indisponível.");
      return;
    }
    // Posição default (Salvador) até chegar telemetria
    map = L.map("map").setView([-12.9777, -38.5016], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
  }

  function atualizarMapa(lat, lng) {
    if (typeof L === "undefined") return;
    initMapIfNeeded();
    if (!map) return;

    if (marker) {
      marker.setLatLng([lat, lng]);
    } else {
      marker = L.marker([lat, lng]).addTo(map);
    }
    map.setView([lat, lng], 14);
  }

  async function atualizar() {
    msg("Atualizando dados...", "info");
    btn.disabled = true;

    try {
      const req = await fetch(`/api/ativos/${ativoId}/monitoramento`);
      const data = await req.json();

      if (!req.ok) {
        msg("Erro: " + (data.detalhe || data.erro || req.status), "erro");
        btn.disabled = false;
        return;
      }

      // status
      statusEl.textContent = data.status_monitoramento || "—";

      // horas motor
      if (typeof data.horas_motor === "number") {
        horasEl.textContent = data.horas_motor.toFixed(1) + " h";
      }

      // tensão
      if (data.tensao_bateria != null) {
        tensaoEl.textContent = Number(data.tensao_bateria).toFixed(1) + " V";
      }

      // última atualização
      if (data.ultima_atualizacao) {
        ultimaEl.textContent = data.ultima_atualizacao;
      }

      // telemetria detalhada
      if (data.telemetria) {
        motorEl.textContent = data.telemetria.motor_ligado ? "Ligado" : "Desligado";

        const lat = data.telemetria.latitude;
        const lng = data.telemetria.longitude;

        if (lat != null && lng != null) {
          coordsEl.textContent = `Latitude: ${lat.toFixed(5)} · Longitude: ${lng.toFixed(5)}`;
          atualizarMapa(lat, lng);
        } else {
          coordsEl.textContent = "Localização ainda não disponível na última telemetria.";
        }
      }

      msg("Dados atualizados com sucesso!", "ok");

    } catch (e) {
      console.error(e);
      msg("Falha inesperada: " + e, "erro");
    }

    btn.disabled = false;
  }

  // Botão manual
  btn.addEventListener("click", atualizar);

  // Atualiza automaticamente ao abrir
  document.addEventListener("DOMContentLoaded", function () {
    initMapIfNeeded();
    atualizar();
  });

})();
</script>
{% endblock %}
